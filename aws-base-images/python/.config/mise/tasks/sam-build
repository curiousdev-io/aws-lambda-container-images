#!/usr/bin/env bash
#MISE description="Build the AWS SAM application"

set -euo pipefail

# Use mise variable for project root
PROJECT_ROOT="${MISE_PROJECT_ROOT:-$(pwd)}"
SAM_DIR="$PROJECT_ROOT/sam"
TEMPLATE_FILE="$SAM_DIR/template.yaml"
BUILD_DIR="$SAM_DIR/.aws-sam/build"

if [[ ! -d "$SAM_DIR" ]]; then
    echo "Error: SAM directory not found at $SAM_DIR" >&2
    exit 1
fi

if [[ ! -f "$TEMPLATE_FILE" ]]; then
    echo "Error: SAM template file not found at $TEMPLATE_FILE" >&2
    exit 1
fi

mkdir -p "$BUILD_DIR"

echo "Building AWS SAM stack..."
if ! sam build --template-file "$TEMPLATE_FILE" --build-dir "$BUILD_DIR"; then
    echo "Error: SAM build failed." >&2
    exit 1
fi
echo "Build complete."